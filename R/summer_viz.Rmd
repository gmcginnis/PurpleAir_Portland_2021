---
title: "sparklines"
author: "Gillian McGinnis"
date: "7/6/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
single_site <- data_hourly %>%
  filter(site_id == "48618823101ce928_2045") %>% 
  select(!c(pm25_cf1_A, pm25_cf1_B, pm25_atm_A, pm25_atm_B, minute)) %>% 
  pivot_longer(cols = c(pm25_cf1, epa_2020, epa_2021, epa_atm, lrapa, pm25_atm),
               names_to = "corr",
               values_to = "pm25") %>% 
  mutate(
    corr = fct_inorder(corr),
    source = fct_collapse(corr,
      PA = c("pm25_cf1", "pm25_atm"),
      EPA = c("epa_2020", "epa_2021", "epa_atm"),
      LRAPA = "lrapa"
    )
  )


single_site %>% 
  ggplot(aes(x = date_hour, y = pm25, color = corr)) +
  facet_grid(source~., scales="free_y") +
  geom_line() +
  theme(legend.position="bottom")

data_diurnal %>% 
  drop_na(epa_2021) %>% 
  #filter(site_id %in% c("48618823101ce928_2045", "a20209a9fb613315_3775", "a0f18656133e64ce_2055")) %>% 
  ggplot(aes(x=hour, y=epa_2021, group=site_id)) +
  geom_path(alpha=0.5) +
  geom_point(shape=1, alpha=0.3)

# data_diurnal %>% 
#   filter(site_id %in% c("48618823101ce928_2045", "a20209a9fb613315_3775", "a0f18656133e64ce_2055")) %>% 
#   drop_na(epa_2021) %>% 
#   ggplot(aes(x=hour,y=epa_2021,group=site_id)) +
#   coord_polar() +
#   geom_path()

data_daily %>% 
  ggplot(aes(x = date, y = epa_2021, group = site_id)) +
  geom_path(alpha=0.5) +
  geom_point(shape = 1, alpha = 0.3)

data_hourly %>% 
  ggplot(aes(x = date_hour, y = epa_2021, group = site_id)) +
  facet_grid(.~date_tag, scales="free") +
  geom_boxplot()
  #geom_point(shape = 1, alpha = 0.5)


single_site %>% 
  filter(corr == "epa_2021") %>% 
  ggplot(aes(x=date,y=hour, fill = pm25)) +
  geom_tile() +
  scale_fill_viridis(name = "Hrly PM25", option = "plasma") +
  facet_grid(.~date_tag, scale="free_x", space="free_x") +
  scale_y_continuous(trans = "reverse", breaks = unique(single_site$hour)) +
  theme_minimal(base_size=8) +
  theme(legend.position="bottom",
        plot.title=element_text(size=14, hjust = 0),
        axis.text.y=element_text(size=6),
        strip.background = element_rect(colour="white"),
        axis.ticks=element_blank(),
        axis.text=element_text(size=7),
        legend.title=element_text(size=8),
        legend.text=element_text(size=6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        #
        panel.border = element_blank(),
        #panel.background = element_blank(),
        #panel.grid = element_blank(),
        panel.spacing = unit(0,"line")
        )

single_site %>% 
  filter(corr=="epa_2021") %>% 
  ggplot(aes(x = date, y = hour, fill = pm25, label = as.character(sprintf("%.2f", round(pm25, digits=2))))) +
  geom_tile() +
  scale_fill_viridis(option = "plasma", limits = c(0, NA)) +
  #geom_text(aes(color=round(pm25, digits=2)), show.legend=FALSE) +
  #scale_color_viridis(option = "plasma", direction = -1, limits = c(0, NA)) +
  geom_text() +
  scale_y_continuous(trans = "reverse", breaks = 0:23) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid = element_blank()
  )

single_site %>% 
  filter(corr=="epa_2021") %>% 
  ggplot(aes(x=hour, y=pm25, color=as.character(date))) +
  geom_line() +
  theme(legend.position="bottom")

```

```{r}
tenn <- unique(data_meta$site_id)[1:10]

data_hourly %>% 
  filter(site_id %in% tenn) %>% 
  left_join(data_meta) %>% 
  ggplot(aes(x = date_hour, y = epa_2021)) +
  facet_grid(label~.) +
  geom_line()

```

```{r}
#devtools::install_github("hrbrmstr/streamgraph")
library(streamgraph)

data_hourly %>% 
  filter(site_id %in% tenn) %>% 
  left_join(data_meta) %>% 
  ungroup() %>% 
  select(label, epa_2021, date_hour, date) %>% 
  streamgraph(key="label",value="epa_2021",date="date_hour") %>% 
  sg_axis_x(1, "date_hour", "%H, %d")

data_daily %>% 
  filter(site_id %in% tenn) %>% 
  ungroup() %>% 
  streamgraph("site_id", "epa_2021", "date") %>% 
  sg_axis_x(1, "date", "%d")
```

```{r}
library(ggridges)

data_hourly %>% 
  filter(site_id %in% tenn) %>% 
  ggplot(aes(x = epa_2021, y = site_id, fill = ..x..)) +
  geom_density_ridges_gradient()+
  scale_fill_viridis(option="C")
```

```{r}
single_site %>%
  distinct() %>% 
  ggplot(aes(x = date_hour, y = pm25, color = corr, linetype=source, fill=corr)) +
  #geom_area(alpha=0.4)
  geom_line() +
  geom_point()
```




```{r}
library(leaflet)

site_handful <- data_hourly %>% 
  filter(site_id %in% c("a20209a9fb613315_3775", "48618823101ce928_2045", "a0f18656133e64ce_2055")) %>% 
  select(!c(pm25_cf1_A, pm25_cf1_B, pm25_atm_A, pm25_atm_B, minute)) %>% 
  pivot_longer(cols = c(pm25_cf1, epa_2020, epa_2021, epa_atm, lrapa, pm25_atm),
               names_to = "corr",
               values_to = "pm25") %>% 
  mutate(
    corr = fct_inorder(corr),
    source = fct_collapse(corr,
      PA = c("pm25_cf1", "pm25_atm"),
      EPA = c("epa_2020", "epa_2021", "epa_atm"),
      LRAPA = "lrapa"
    )
  ) %>% 
  left_join(data_meta)

pm_pal <- colorNumeric(palette = "viridis", domain = site_handful$pm25)

leaflet(data=site_handful) %>% 
  addTiles() %>% 
  # addCircles(
  #   data = (site_handful %>% )
  # )
  addCircles(color = ~pm_pal(pm25)) %>% 
  addLayersControl(
    baseGroups = c("Before", "ID", "After")
  )
```

```{r}
data_full <- data_daily %>% 
  left_join(data_meta) %>% 
  select(!date_tag) %>% 
  rename(date_tag = date) %>% 
  drop_na(epa_2021)

date_tag_list <- as.character(unique(data_full$date_tag))
map <- leaflet(data_full) %>% 
  addProviderTiles(providers$CartoDB.DarkMatter)
pal <- colorNumeric(palette = "viridis", domain = data_full$epa_2021)

pm_popup <- paste0("<b>",data_full$label,"</b> (",data_full$latitude,", ",data_full$longitude,")",
                   "<br><b>Device location:</b> ", data_full$DEVICE_LOCATIONTYPE,
                  "<br><b>Internal temperature (\u00B0F):</b> ", data_full$temperature,
                  "<br><b>RH (%):</b> ", data_full$humidity,
                  "<br><b>EPA 2020:</b> ", data_full$epa_2020,
                  "<br><b>EPA 2021:</b> ", data_full$epa_2021,
                  "<br><b>LRAPA:</b> ", data_full$lrapa,
                  " (", data_bc$event, ")")


for(date_tag_single in date_tag_list){
  data_temp <- data_full[data_full$date_tag == date_tag_single,]
  
  map <- map %>%
    addCircleMarkers(
      data = data_temp,
      lng = ~longitude,
      lat = ~latitude,
      color = ~pal(epa_2021),
      radius = 5,
      fillOpacity = 0.5,
      #radius = ~sqrt(epa_2021),
      group = date_tag_single,
      label = ~as.character(round(epa_2021, digits=2))
    )
  
  #remove(data_temp, date_tag_single, date_tag_list)
}
map %>%
  addLayersControl(
    baseGroups = date_tag_list,
    options = layersControlOptions(collapsed = FALSE)
  )
```




```{r, viz_time, eval=FALSE}
long_set <- data_hourly %>% 
  pivot_longer(cols = c(pm25_cf1, epa_2020, epa_2021, epa_atm, lrapa, pm25_atm),
               names_to = "corr",
               values_to = "pm25") %>% 
  mutate(
    corr = fct_inorder(corr),
    source = fct_collapse(corr,
      PA = c("pm25_cf1", "pm25_atm"),
      EPA = c("epa_2020", "epa_2021", "epa_atm"),
      LRAPA = "lrapa"
    )
  )

long_set %>% 
  ggplot(aes(date_hour, pm25, color = corr)) +
  facet_wrap(~date_tag, scales = "free") +
  geom_point(alpha = 0.1, shape = 1) +
  stat_smooth() +
  #geom_line()
  theme(legend.position = "bottom")

long_set %>% 
  #ggplot(aes(source, value, color = name)) +
  ggplot(aes(corr, pm25, color = source)) +
  #facet_wrap(~date_tag, scales = "free") +
  facet_wrap(~hour_tag, scales = "free") +
  #facet_wrap(~date_tag) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), linetype = "dotted") +
  geom_violin(draw_quantiles = 0.5, fill = "transparent") +
  stat_summary(fun.y = mean, geom ="point", color = "red") +
  theme(legend.position = "bottom")

long_set %>% 
  select(!c(pm25_cf1_A,pm25_cf1_B,pm25_atm_A,pm25_atm_B)) %>% 
  mutate(wday = lubridate::wday(date,label=TRUE)) %>% 
  #group_by(site_id, hour, wday, corr, source) %>% 
  group_by(hour, wday, corr, source) %>% 
  summarize_if(is.numeric, mean, na.rm=TRUE) %>% 
  ggplot(aes(x=hour, y=pm25, color=corr)) +
  facet_grid(source~wday, scales="free_y") +
  geom_line() +
  theme(legend.position="bottom")
```

```{r,eval=FALSE}
leveled_meta <- data_meta %>% 
  mutate(label = fct_reorder(as.factor(label), desc(latitude)))
  # arrange(desc(latitude)) %>% 
  # mutate(label = fct_inorder(as.factor(label)))

data_hourly %>% 
  drop_na(epa_2021) %>% 
  left_join(leveled_meta) %>% 
  select(label, date_hour, DEVICE_LOCATIONTYPE, epa_2021) %>% 
  full_join(
    (data_deq %>%
       select(date_hour, pm25_deq) %>%
       mutate(DEVICE_LOCATIONTYPE = "deq", label = "deq") %>%
       rename(epa_2021=pm25_deq) %>% 
       filter(date_hour >= min(data_hourly$date_hour),
              date_hour <= max(data_hourly$date_hour)))
  ) %>% 
  mutate(DEVICE_LOCATIONTYPE = factor(DEVICE_LOCATIONTYPE, levels = c("inside", "deq", "outside"))) %>% 
  ggplot(aes(x = date_hour, y = label, fill = epa_2021)) +
  facet_grid(DEVICE_LOCATIONTYPE~., scales="free_y", space="free_y") +
  geom_tile() +
  scale_fill_viridis(option="plasma", limits=c(0, 50))
```

```{r,eval=FALSE}
ggplot(data_daily, aes(x = date, y = epa_2021, group = date)) +
  geom_violin() + 
  geom_jitter()

data_daily %>% 
  left_join((data_meta %>% group_by(DEVICE_LOCATIONTYPE) %>% slice(1:20))) %>% 
  drop_na(label) %>% 
  # mutate(date = as.character(date)) %>% 
  #filter(str_detect(label, "rd Drive")) %>% 
  ggplot(aes(x = date, y = epa_2021, group = date)) +
  facet_grid(DEVICE_LOCATIONTYPE~.) +
  geom_boxplot()

data_hourly %>% 
  left_join((data_meta %>% group_by(DEVICE_LOCATIONTYPE) %>% slice(1:20))) %>% 
  ggplot(aes(x = hour, y = epa_2021, group = site_id)) +
  facet_grid(date~DEVICE_LOCATIONTYPE) +
  geom_point()

data_hourly %>% 
  left_join((data_meta %>% filter(str_detect(label,"rd Drive")))) %>% 
  drop_na(label) %>% 
  ggplot(aes(x = hour, y = epa_2021, color = date, group = date)) +
  geom_line()

data_daily %>% 
  left_join((data_meta %>% group_by(DEVICE_LOCATIONTYPE) %>% slice(1:10))) %>% 
  drop_na(label) %>% 
  mutate(date = day(date)) %>% 
  streamgraph(
    key="site_id",
    value="epa_2021",
    date="date",
    scale = "continuous"
  )
  # sg_axis_x(5,tick_units="day")

library(highcharter)
data_daily %>% 
  left_join(data_meta) %>% 
  # left_join((data_meta %>% group_by(DEVICE_LOCATIONTYPE) %>% slice(1:10))) %>%
  # drop_na(label) %>%
  hchart("streamgraph", hcaes(date, epa_2021, group=label))
```

