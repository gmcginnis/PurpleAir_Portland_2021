---
title: "mapping"
author: "Gillian McGinnis"
date: "6/9/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggmap)
library(viridis)
```

```{r data_loading}
data_day <- read.csv("data/wrangled_new/wrangled_day.csv")
```

```{r get_map, eval = FALSE}
#
lat_min <- 45.4
#lat_max <- 45.65 #old val that would include the point in Vancouver
lat_max <- 45.6
long_min <- -122.854
long_max <- -122.58


pdx_box <- c(
  bottom = lat_min,
  top = lat_max,
  left = long_min,
  right = long_max
)

#avaialble maps: terrain, terrain-background, terrain-labels, terrain-lines, toner, toner-2010, toner-2011, toner-background, toner-hybrid, toner-labels, toner-lines, toner-lite, watercolor
pdx_map <- get_stamenmap(
  pdx_box,
  maptype = "toner-lite",
  zoom = 11
)

save(pdx_map, file = "data/maps/pdx_map.RData")
```

```{r date_range_inputs}
# pre
date_pre_start <- as.Date("2020-09-01")
date_pre_end <- as.Date("2020-09-09")
# during
date_fire_start <- as.Date("2020-09-10")
date_fire_end <- as.Date("2020-09-19")
# post
date_post_start <- as.Date("2020-09-20")
date_post_end <- as.Date("2020-09-29")
```

```{r epa_wrangle}
data_corr <- data_day %>% 
  filter(inout == "outside") %>% 
  rename(
    cf1 = `PM2.5_CF1_ug.m3`,
    #atm = `PM2.5_ATM_ug.m3`,
    temp = `Temperature_F`,
    rh = `Humidity_.`
  ) %>% 
  filter(!(cf1 >= 1000)) %>% #filtering out max range
  select(c(loc_tag, ab, long, lat, date, cf1, temp, rh)) %>% 
  pivot_wider(names_from = ab, values_from = cf1) %>% 
  mutate(
    diff = (A-B),
    per_diff = 100*(abs(A-B))/((A+B)/2),
    drop = case_when(
      abs(diff) >= 5 & abs(per_diff) >= 62 ~ TRUE,
      TRUE ~ FALSE #fills all others with false
    )
  ) %>% 
  filter(drop != TRUE) %>% 
  select(!c(drop, diff, per_diff)) %>% 
  pivot_longer(cols = c("A", "B"), names_to = "ab") %>%
  group_by(loc_tag, long, lat, date) %>% 
  summarize(cf1 = mean(value, na.rm = TRUE),
            temp = mean(temp, na.rm = TRUE),
            rh = mean(rh, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(
    "epa_2020" = 0.524*cf1 - 0.0852*rh + 5.72,
    "epa_2021" = case_when(
      cf1 <= 343 ~ 0.52*cf1 - 0.086*rh + 5.75,
      cf1 > 343 ~ 0.46*cf1 + (3.93*10^(-4))*(cf1^2) +2.97
    )
  ) %>% 
  filter(loc_tag != "Ogden84th") #removing Vancouver point
```

```{r epa_date_range_wrangle}
load("data/maps/pdx_map.RData")

data_ranged <- data_corr %>% 
  mutate(
    range = case_when(
      date >= date_pre_start & date <= date_pre_end ~ "pre",
      date >= date_fire_start & date <= date_fire_end ~ "fire",
      date >= date_post_start & date <= date_post_end ~ "post"
    ),
    range = factor(range, levels = c("pre", "fire", "post"))
  ) %>% 
  drop_na(range) %>% 
  group_by(loc_tag, long, lat, range)

# data_cf1 <- data_ranged %>% 
#   summarize(mean = mean(cf1))
# 
# data_epa20 <- data_ranged %>% 
#   summarize(mean = mean(epa_2020))
# 
# data_epa21 <- data_range %>% 
#   summarize(mean = mean(epa_2021))
# 
# pdx_map %>% 
#   ggmap() +
#   geom_point(
#     data = data_corr,
#     aes(x = long, y = lat, color = cf1),
#     inherit.aes = FALSE
#   )

map_aq <- function(pm25_input, range_input) {
  data_filtered <- data_ranged %>% 
    filter(range == {{range_input}}) %>% 
    summarize(mean = mean({{pm25_input}})) %>% 
    ungroup()
  return(data_filtered)
  
  pdx_map %>% 
    ggmap() +
    geom_point(
      data = data_filtered,
      aes(x = long, y = lat, color = mean),
      inherit.aes = FALSE
    ) +
    scale_color_viridis()
}

map_aq(cf1, "pre")

pdx_map %>% 
  ggmap() +
  facet_wrap(~range) +
  geom_point(
    data = data_ranged,
    aes(x = long, y = lat, color = cf1),
    inherit.aes = FALSE
  ) +
  scale_color_viridis() +
  theme(legend.position = "bottom")
```

```{r epa_corr_viz}
data_ranged_long <- data_ranged %>% 
  pivot_longer(cols = c(cf1, epa_2020, epa_2021), names_to = "corr_factor", values_to = "pm_val") %>% 
  group_by(loc_tag, long, lat, range, corr_factor) %>% 
  summarise_at(c("temp", "rh", "pm_val"), mean, na.rm = TRUE)

#map_wildfire_epa <- pdx_map %>% 
pdx_map %>% 
  ggmap() +
  facet_grid(corr_factor~range) +
  geom_point(
    data = data_ranged_long,
    aes(x = long, y = lat, color = pm_val),
    inherit.aes = FALSE
  ) +
  scale_color_viridis() +
  labs(
    title = "Map of PM2.5 values in PDX",
    subtitle = "Columns corrolate to time ranges.\nRows represent correction factors.",
    color = "PM2.5 (Âµg/m^3): "
  ) +
  theme_void() +
  theme(
    legend.position = "top",
    plot.background = element_rect(fill = "darkgray")
  )

#having trouble w ggsave right now.. will do manually
#ggsave(map_wildfire_epa, device = "png", path = "figures/map_wildfire_epa.png")
```


