---
title: "summer_deq"
author: "Gillian McGinnis"
date: "6/17/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(readxl)
library(lubridate)
```


```{r inputs}
input_deq_path <- "data/deq/SEL_july.xlsx"
```

```{r settings}
# Input of renames. Those listed will be included in the final data frame.
# Time stamp will be automatically renamed and kept.
input_deq_renames <- c(
  "PM2.5" = "pm25_deq",
  "Temperature" = "temperature_c",
  "Relative Humidity" = "rh",
  "Wind Direction" = "wind_direction",
  "Wind Speed (mph)" = "wind_speed",
  "Black Carbon (BC6 880nm)" = "black_carbon"
)
```


```{r data_import}

# Creating a list of variable names
data_deq_names <- read_excel(input_deq_path,
                             sheet = 1, # Selecting sheet 1
                             skip = 2, # Skipping the empty rows at the top
                             n_max = 0) %>% names() # Selecting 0 observations, and extracting the names only

# Creating a data frame of the data
data_deq_raw <- read_excel(input_deq_path,
                           sheet = 1, # Selecting sheet 1
                           skip = 4, # Skipping the topmost rows naming the variables, etc
                           na = "----", # NAs are reported using this symbol in the Excel file
                           col_names = data_deq_names) # setting column names to be those listed above

# Data frame of units, for reference if needed.
deq_units <- read_excel(input_deq_path,
                        sheet = 1, # Selecting sheet 1
                        skip = 2, # Skipping the empty rows at the top
                        n_max = 1) # Selecting 1 "observation" (next row)
```

```{r eclean_read}
remove(data_deq_names, deq_units)
```


```{r data_wrangling}
data_deq <- data_deq_raw %>% 
  mutate(
    # DEQ reports time stamps in STANDARD time, meaning DST is not accounted for.
    # Using Etc/GMT+8 here will apply the appropriate -8
    datetime_standard = parse_date_time(`Date Time`, "%H:%M %m/%d/%Y", tz = "Etc/GMT+8"),
    # The following will adjust time stamps for DST appropriately:
    `Date Time` = with_tz(datetime_standard, tzone = "America/Los_Angeles"),
    date = date(`Date Time`)
  ) %>% 
  rename(date_hour = `Date Time`) %>% 
  # Renaming variables based on inputs at the top
  plyr::rename(warn_missing = FALSE, input_deq_renames) %>% 
  # Selecting only renamed variables in addition to time stamps
  select(c(date, date_hour, intersect(all_of(input_deq_renames), names(.)), datetime_standard))
```

```{r eclean_wrangle}
remove(data_deq_raw, input_deq_path, input_deq_renames)
```
