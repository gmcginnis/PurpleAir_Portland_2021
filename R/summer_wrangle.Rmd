---
title: "summer_wrangle"
author: "Gillian McGinnis"
date: "6/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
```

```{r inputs}
input_path <- "data/raw"
input_file <- "data/raw/Bridlemile (outside) (45.493717 -122.716816) Primary Real Time 09_01_2020 11_30_2020.csv"
input_skips <- c("entry_id", "UptimeMinutes", "V11")
# input_selects <- c("created_at",
#                    "PM2.5_CF1_ug/m3",
#                    "PM2.5_ATM_ug/m3",
#                    "Temperature_F",
#                    "Humidity_%")
input_selects <- c("date_time",
                   "pm2.5_cf1",
                   "pm2.5_atm",
                   "temp",
                   "rh")

file_list <- list.files(path = input_path,
                        #pattern = "STAR.+Primary",
                        #pattern = ".*STAR.*",
                        full.names = TRUE)
```


```{r for_loop}
remove(temp_primary_a)
remove(data_primary_a)
remove(file_single)
data_primary_a <- data.frame(NA)

for(file_single in file_list){
  if(
    str_detect(file_single, "\\) Primary") == TRUE &
    str_detect(file_single, "B(?= \\((outside|inside|undefined))") == FALSE
  ){
    temp_primary_a <- fread(file_single,
                          sep = ",",
                          drop = input_skips,
                          fill = TRUE) %>% 
        plyr::rename(warn_missing = FALSE,
                     c(
                       "created_at" = "date_time",
                       "PM1.0_CF1_ug/m3" = "pm1_cf1",
                       "PM2.5_CF1_ug/m3" = "pm2.5_cf1",
                       "PM10.0_CF1_ug/m3" = "pm10_cf1",
                       "UptimeMinutes" = "uptime_min",
                       "RSSI_dbm" = "rssi_dbm",
                       "Temperature_F" = "temp",
                       "Humidity_%" = "rh",
                       "PM2.5_ATM_ug/m3" = "pm2.5_atm"
                       )
        ) %>% 
      select(all_of(input_selects)) %>%
      mutate(
        date_time_utc = as.POSIXct(date_time, tz = "UTC"),
        date_time = lubridate::with_tz(date_time_utc, "America/Los_Angeles")
      ) %>% 
      select(!date_time_utc) %>% 
      mutate(
        source = file_single,
        loc_path = str_extract(source, "\\w.+(?= \\((outside|inside|undefined))"),
        loc_tag = str_replace(loc_path, paste(input_path, "/", sep = ""), ""),
        loc_ab = str_extract(source, "B(?= \\((outside|inside|undefined))"),
        loc_ab = replace_na(loc_ab, "A"),
        loc_inout = str_extract(source, "(?!\\()(outside|inside)(?=\\))"),
        lat = str_extract(source, "(?!\\()-*\\d+\\.\\d+(?= )"),
        long = str_extract(source, "-*\\d+\\.\\d+(?=\\))")
      ) %>% 
      select(!c(source, loc_path)) %>% 
      group_by(loc_tag) %>% 
      fill(loc_inout) %>% 
      mutate(
        loc_ab = factor(loc_ab, levels = c("A", "B")),
        loc_inout = factor(loc_inout, levels = c("outside", "inside")),
        lat = as.numeric(lat),
        long = as.numeric(long)
      )
    
    data_primary_a <- plyr::rbind.fill(data_primary_a, temp_primary_a)
  }
}
  
```

```{r small_testing}
fread(input_file,
                  sep = ",",
                  drop = input_skips,
                  fill = TRUE
  ) %>% 
  plyr::rename(
    warn_missing = FALSE,
    c(
      "created_at" = "date_time",
      "PM1.0_CF1_ug/m3" = "pm1_cf1",
      "PM2.5_CF1_ug/m3" = "pm2.5_cf1",
      "PM10.0_CF1_ug/m3" = "pm10_cf1",
      "UptimeMinutes" = "uptime_min",
      "RSSI_dbm" = "rssi_dbm",
      "Temperature_F" = "temp",
      "Humidity_%" = "rh",
      "PM2.5_ATM_ug/m3" = "pm2.5_atm"
    )
  ) %>%
  select(all_of(input_selects)) %>%
  mutate(
    date_time_utc = as.POSIXct(date_time, tz = "UTC"),
    date_time = lubridate::with_tz(date_time_utc, "America/Los_Angeles")
  ) %>% 
  select(!date_time_utc) %>% 
  mutate(
    source = input_file,
    loc_path = str_extract(source, "\\w.+(?= \\((outside|inside|undefined))"),
    loc_tag = str_replace(loc_path, paste(input_path, "/", sep = ""), ""),
    loc_ab = str_extract(source, "B(?= \\((outside|inside|undefined))"),
    loc_ab = replace_na(loc_ab, "A"),
    loc_inout = str_extract(source, "(?!\\()(outside|inside)(?=\\))"),
    lat = str_extract(source, "(?!\\()-*\\d+\\.\\d+(?= )"),
    long = str_extract(source, "-*\\d+\\.\\d+(?=\\))")
  ) %>% 
  select(!c(source, loc_path)) %>% 
  group_by(loc_tag) %>% 
  fill(loc_inout) %>% 
  mutate(
    loc_ab = factor(loc_ab, levels = c("A", "B")),
    loc_inout = factor(loc_inout, levels = c("outside", "inside")),
    lat = as.numeric(lat),
    long = as.numeric(long)
  )
```

```{r, eval = FALSE}
# https://www.r-bloggers.com/2011/06/merge-all-files-in-a-directory-using-r-into-a-single-dataframe/
for (file in file_list){
      
  # if the merged dataset doesn't exist, create it
  if (!exists("dataset")){
    #dataset <- read.table(file, header=TRUE, sep="\t")
    dataset <- fread(file,
                  sep = ",",
                  drop = input_skips,
                  fill = TRUE
  )
  }
  
  # if the merged dataset does exist, append to it
  if (exists("dataset")){
    temp_dataset <-fread(file,
                  sep = ",",
                  drop = input_skips,
                  fill = TRUE
  )
    dataset<-rbind(dataset, temp_dataset)
    rm(temp_dataset)
  }

}
```
